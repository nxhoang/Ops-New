function attendanceDateOnchanged(){document.getElementById(TxtAttendDate).addEventListener("change",n=>{n.currentTarget.value&&n.currentTarget.value!==""&&new Date(n.currentTarget.value)>new Date&&(MsgInform("Error","Attendance date is not future","error",!1,!0),n.currentTarget.value=(new Date).yyyymmddhyphen())})}function getDeptCodesByFactory(n){$.blockUI({message:AjaxWaitMes});$.post(UrlGetDeptCodesByFactory,{factories:n}).done(n=>{n.IsSuccess&&n.Result&&insertOptToSectionSel(n.Result)}).fail((n,t,i)=>{HandleException(n,t,i)}).always(()=>{$.unblockUI()})}function insertOptToSectionSel(n){const i=[];for(var t of n){const n={label:t.Section,title:t.FullName,value:t.DeptCode};i.push(n)}$(`#${SelSection}`).multiselect("dataprovider",i)}function insertOptToEmpSel(n){const i=[];for(var t of n){let n;switch(t.Gender){case"Male":n=" ♂️ M";break;case"Female":n=" ♀ F";break;default:n=""}const r={label:`${t.EmployeeCode}-${t.Name} ${n}`,title:`${t.EmployeeCode}-${t.Name}`,value:t.EmployeeCode};i.push(r)}$(`#${selEmp}`).multiselect("dataprovider",i)}function checkedAttendEvent(){document.getElementById(chkAttendEmp).addEventListener("click",()=>{isCheckAttendance=this.checked,$(`#${divAttDate}`).toggle("slow")})}function BulkInsertAttendEmp(n,t,i,r){$.blockUI({message:AjaxWaitMes});const u=new AjaxConfig(UrlBulkInsertAttEmps,!0,JSON.stringify({factory:n,selectedTeams:t,attDate:i,isPresent:r}));AjaxPostCommon(u,n=>{n.IsSuccess||(n.ErrorCode===1&&MsgInform("Info",n.Log,"info",!1,!0),console.log(n.Log)),n.IsSuccess&&n.Result&&(insertOptToEmpSel(n.Result),getEmpImagePath().done(t=>{console.log(t),t.IsSuccess&&getOp().done(i=>{if(i.opdts&&i.opdts.nodes){const r=[],u=createEmpRect(n.Result,r,t.Result),f=createPrcRect(i.opdts,u.assignedEmps),e=f.concat(u.rects);$.when.apply($,r).done(()=>{cvEmpPlugin[0].bindData(e)})}})})),console.log(n)}).fail(n=>{console.log(`${n.statusText} ${n.status}`)}).always(()=>{$.unblockUI()})}function getAttendEmps(){$.blockUI({message:AjaxLoadMdMes});$.getJSON(getAttendEmpsUrl,{}).done(n=>{n&&n.items&&console.log(n.items)}).fail(n=>{console.log(`${n.statusText} ${n.status}`)}).always(()=>{$.unblockUI()})}function getCorps(){$.getJSON(getCorpsUrl).done(n=>{if(n&&n.items){const t=[];let i=!1;$.each(n.items,(n,r)=>{if(r&&r.FULLNAME&&r.FULLNAME.trim()!==""){const n={label:r.FULLNAME,title:r.SHORTNAME,value:r.DEPTCODE};t.push(n);r.DEPTCODE==="1002"&&(i=!0)}});$(`#${ddlCorp}`).multiselect("dataprovider",t);i&&($(`#${ddlCorp}`).multiselect("deselect",n.items[0].DEPTCODE),$(`#${ddlCorp}`).multiselect("select",["1002"]));const r=$(`#${ddlCorp} option:selected`).val();getDeptTeamsByCorp(r)}}).fail(n=>{console.log(`${n.statusText} ${n.status}`)}).always(n=>{console.log(n)})}function getDeptTeamsByCorp(n){$.blockUI({message:AjaxLoadMdMes});$.getJSON(getDeptTeamsByCorpUrl,{corp:n}).done(n=>{if(n&&n.items){const t=[];$.each(n.items,(n,i)=>{if(i&&i.TEAM_NAME&&i.TEAM_NAME.trim()!==""){const n={label:i.TEAM_NAME,title:i.TEAM_NAME,value:i.TEAM_CODE};t.push(n)}});$(`#${ddlDeptTeam}`).multiselect("dataprovider",t)}}).fail(n=>{console.log(`${n.statusText} ${n.status}`)}).always(()=>{$.unblockUI()})}function clickOkSearchEmp(){document.getElementById("btnOkeFilterEmp").addEventListener("click",n=>{n.preventDefault();console.log("Searching worker...");const t=$(`#${ddlDeptTeam} option:selected`).val(),i=document.getElementById(TxtAttendDate).value;console.log(t);console.log(i)})}function submitSearchEmpForm(n){n.preventDefault();console.log("Searching employee...");const r=document.getElementById(chkAttendEmp).checked,i=document.getElementById(TxtAttendDate).value.replace(/-/g,""),u=$(`#${SelSection} option:selected`),t=[];if(u.map((n,i)=>{t.push(i.value)}),console.log(t),CurrentTeams=t,console.log(document.getElementById(TxtAttendDate).value),r){const n=document.getElementById(selectedFactorySpan);if(n&&n.title){const n=document.getElementById(selectedFactorySpan).title.replace(/-/g,"").split(" ")[1],r=document.getElementById(SelSection).value;console.log(n);console.log(i);console.log(r);i?t.length>0?BulkInsertAttendEmp(n,t,i,!0):MsgInform("Error","Please select team.","error",!1,!0):MsgInform("Error","Please select date.","error",!1,!0)}else MsgInform("Error","Please select a factory.","error",!1,!0)}else reloadAll(t)}function getAttendanceEmps(n,t){return $.blockUI({message:"<h3>Please wait...<\/h3>"}),$.post(UrlGetAttEmps,{factory:n,attDate:t}).done(n=>{console.log(n),$.unblockUI()}).fail((n,t,i)=>{HandleException(n,t,i)})}function initDeptTeamDdl(){$(`#${ddlDeptTeam}`).multiselect({includeSelectAllOption:!0,enableCaseInsensitiveFiltering:!0,buttonWidth:180,maxHeight:300,onChange:(n,t)=>{console.log(n),console.log(t)},onSelectAll:n=>{console.log(n)}})}function initMultiSelect(n,t,i,r){$(`#${n.selId}`).multiselect({includeSelectAllOption:r===!1?!1:!0,enableCaseInsensitiveFiltering:!0,buttonWidth:n.buttonWidth,maxHeight:n.maxHeight,onChange:(n,i)=>{t(i,n[0].value)},onSelectAll:n=>{i(n)}})}function initCorpDdl(){$(`#${ddlCorp}`).multiselect({includeSelectAllOption:!0,enableCaseInsensitiveFiltering:!0,buttonWidth:180,maxHeight:300,onChange:(n,t)=>{t&&(console.log(n[0].value),getDeptTeamsByCorp(n[0].value))},onSelectAll:n=>{console.log(n)}})}function getEmployeesFromApi(){console.log("Beginning loading list of employees then inserting to database.");const n=`/MesLineAllocation/BulkInsertEmployee`;$.getJSON(n).done(n=>{console.log(n),console.log("Done loading list of employees and inserting to database.")}).fail(n=>{console.log(n)}).always(n=>{console.log(n)})}function opWorkerMapTabClick(){$("#opEmployeeMappingLink").on("click",()=>{$(".multiselect-container.dropdown-menu").draggable();const n=document.getElementById(selectedFactorySpan);if(n&&n.title){const n=$("#drpFactory").val();console.log(n);getDeptCodesByFactory([n])}else console.error("No selected factory");cvEmpPlugin[0].bindData([])})}function getImage(n){return new Promise(function(t,i){const r=new Image;r.onload=function(){t(r)};r.onerror=function(n){i(n)};r.src=n})}function imageExists(n){const t=new XMLHttpRequest;return t.open("HEAD",n,!1),t.send(),t.status!==404}function createEmpRect(n,t,i){const f=[],e=[];let u=30,o=30,s=0,h=1;for(var r=0;r<n.length;r++){if(n[r].Name.length>17&&(n[r].Name=cutOffEmpName(n[r].Name)),console.log(`${i}/${n[r].ImageName}`),n[r].ImageName&&imageExists(`${i}/${n[r].ImageName}`)){n[r].ImageUrl=`${i}/${n[r].ImageName}`;const u=new Image;u.src=n[r].ImageUrl;console.log(n[r].ImageUrl);n[r].UserImg=u;const f=getImage(n[r].ImageUrl);console.log(f);t.push(f)}else n[r].ImageUrl="";n[r].StyleCode?f.push(n[r]):(e.unshift(cvEmpPlugin[0].createRect("emp",u,o,100,120,empBorderColor,empBgColor,empTextColor,!1,!0,n[r])),3*h-1===s?(h++,o+=135,u=30):u+=130,s++)}return{assignedEmps:f,rects:e}}function createPrcRect(n,t){const r=[];let u=500,f=30,e=1,o=6;for(var i=0;i<n.nodes.length;i++){const h=t.filter(t=>t.OpSerial===n.nodes[i].OpSerial.toString());h&&h.length>0&&h[0]&&(n.nodes[i].Emp=h[0]);let s=n.nodes[i].DisplayColor?`#${n.nodes[i].DisplayColor.substring(3,9)}`:"#FAF7F8";s=s.length===4||s.length===7?s:"#fff";n.nodes[i].XPos===0&&n.nodes[i].YPos===0?(r.unshift(cvEmpPlugin[0].createRect("prc",u,f,100,120,"#3b3b3b",s,"#3b3b3b",!1,!0,n.nodes[i])),o*e-1===i?(e++,f+=135,u=500):u+=130):r.unshift(cvEmpPlugin[0].createRect("prc",n.nodes[i].XPos,n.nodes[i].YPos,100,120,"#3b3b3b",s,"#3b3b3b",!1,!0,n.nodes[i]))}return r}function getEmpImagePath(){return $.getJSON(UrlGetEmpImageUrlConfig).done(n=>{console.log(n)}).fail(n=>{console.log(`${n.statusText} ${n.status}`)}).always(()=>{})}function reloadAll(n){const t=new OpMaster(CurrentOpmt.StyleCode,CurrentOpmt.StyleColorSerial,CurrentOpmt.StyleSize,CurrentOpmt.RevNo,CurrentOpmt.OpRevNo),i=getOp(),r=getOpEmps("Production",n,t),u=getEmpImagePath();$.when(i,r,u).done((n,t,i)=>{if(console.log(i),t[1]==="success"&&t[0].IsSuccess===!0&&t[0].Result){const r=[],u=createEmpRect(t[0].Result,r,i[0].Result);if(n[1]==="success"&&n[0].opdts&&n[0].opdts.nodes){const t=createPrcRect(n[0].opdts,u.assignedEmps),i=t.concat(u.rects);$.blockUI({message:AjaxLoadingImgMes});$.when.apply($,r).done(()=>{cvEmpPlugin[0].bindData(i),$.unblockUI()})}}})}function cutOffEmpName(n){const i=n.split(" ");let r=i[0];for(var t=0;t<i.length;t++)t>0&&i[t].trim()!==""&&(r+=" "+i[t].substring(0,1)),t===i.length-1&&(r+=" "+i[t]);return r}function getOp(){return $.blockUI({message:"<h3>Loading...<\/h3>"}),$.post(UrlGetOpdts,{opsMaster:CurrentOpmt,groupMode:CurrentGroupMode,languageId:currentLang}).done(n=>{console.log(n),n&&n.opdts?opGroupTbEmp[0].bindOpGroup(n.opdts.groups):console.log(n),$.unblockUI()}).fail((n,t,i)=>{HandleException(n,t,i)})}function getOpEmps(n,t,i){$.blockUI({message:bumLoadEmp});i.MxPackage=CurrentMesPackage.MxPackage;const r={dept:n,teams:t,opmt:i},u=new AjaxConfig(getOpEmpsByTeamsUrl,!0,JSON.stringify(r));return AjaxPostCommon(u,n=>{n.IsSuccess?insertOptToEmpSel(n.Result):console.log(n.Log)}).always(()=>{$.unblockUI()})}function toggleSearchEmp(){document.getElementById("btnFilterEmp").addEventListener("click",()=>{$(`#${btnOkeFilterEmp}`).toggle(),$(`#${divFilterEmp}`).slideToggle("slow","easeOutBounce")})}function opWorkerDivMouseUp(){document.getElementById(FacWorkerDivEmp).addEventListener("click",()=>{cvEmpPlugin[0]&&(document.getElementById(BtnSaveOpEmpChanges).disabled=!cvEmpPlugin[0].isLayoutChange())})}function opEmpSaveChanges(){document.getElementById(BtnSaveOpEmpChanges).addEventListener("click",()=>{console.log("saving ..."),saveEmpOp()})}function saveEmpOp(n){const t=mapRectToOpdt(n),i={Message:AjaxSavingMes,Url:UrlSaveEmpOpChanges,Data:{opdts:t}};AjaxPostShortHand(i,n=>{console.log(n),n.IsSuccess&&(MsgInform("Inform","Saved","info",!1,!0),document.getElementById(BtnSaveOpEmpChanges).disabled=!0,cvEmpPlugin[0].setIsChange(!1))})}function mapRectToOpdt(n){const i=[];for(var t of n)if(t.Type==="prc"){const n=t.Data.Emp&&t.Data.Emp.EmployeeCode?t.Data.Emp.EmployeeCode:null,r=new WorkerOpdt(t.Data.StyleCode,t.Data.StyleColorSerial,t.Data.StyleSize,t.Data.RevNo,t.Data.OpRevNo,t.Data.OpSerial,n,t.X,t.Y);i.push(r)}return i}var isSyncEmployee=!1,opGroupTbEmp,cvEmpPlugin,isCheckAttendance=!1,CurrentEmps,firstSelFilter=!1,CurrentAssignedEmp=[],CurrentRects=[],CurrentTeams;const btnFilterEmp="btnFilterEmp",divFilterEmp="divFilterEmp",btnOkeFilterEmp="btnOkeFilterEmp",ddlDeptTeam="ddlDeptTeam",ddlCorp="ddlCorp",selEmp="selEmp",selSkill="selSkill",chkAttendEmp="chkAttendEmp",divAttDate="divAttDate",drpFactory="drpFactory",selectedFactorySpan="select2-drpFactory-container",SelSection="selSection",TxtAttendDate="txtAttendDate",BtnSaveOpEmpChanges="btnOpEmpSaveChanges",FacWorkerDivEmp="facWorkerDivEmp",getDeptTeamsByCorpUrl="/MesLineAllocation/GetDeptTeamByCorpApi",getCorpsUrl="/MesLineAllocation/GetCorpsApi",getAttendEmpsUrl="/MesLineAllocation/GetAttendEmpsApi",getOpEmpsUrl="/MesLineAllocation/GetOpEmps",getOpEmpsByTeamsUrl="/MesLineAllocation/GetOpEmpsByTeams",UrlGetAttEmps="/MesLineAllocation/GetAttEmps",UrlGetDeptCodesByFactory="/MesLineAllocation/GetDeptCodesByFactory",UrlBulkInsertDeptTeam="/MesLineAllocation/BulkInsertDeptTeam",UrlBulkInsertAttEmps="/MesLineAllocation/BulkInsertAttEmp",UrlSaveEmpOpChanges="/MesLineAllocation/SaveOpEmpChanges",UrlGetEmpImageUrlConfig="/MesLineAllocation/GetEmpImageUrlConfig",AjaxWaitMes="<h3>Please wait...<\/h3>",AjaxLoadingImgMes="<h3>Loading employee images...<\/h3>",bumLoadEmp="<h3>Loading workers...<\/h3>",empBgColor="#FAF7F8",empBorderColor="#5588ee",empTextColor="#5588ee",prcBorderColor="#3b3b3b",prcTextColor="#3b3b3b";(()=>{opWorkerMapTabClick(),opGroupTbEmp=$("#divDisplayOpGroupEmp").opGroupTablePlugin({btnDisplayTableId:"btnDisplayOpGroupEmp",iconDisplayId:"iDopSignEmp",opGroupTableDivId:"divOpGroupTableEmp",opGroupTbodyTableId:"tBodyDisplayGroupEmp",isShowTable:!1,opGroups:[]}),cvEmpPlugin=$("#facWorkerDivEmp").humanMapPlugin({CanvasWidth:3e3,CanvasHeight:6e3,DragOk:!1,RectArray:[],EmpImgDir:"/Assets/jquery.human-task-map/img",onRefreshCanvas:(n,t)=>{!t&&CurrentTeams&&CurrentTeams.length>0&&reloadAll(CurrentTeams)},onSaveCanvas:(n,t)=>{saveEmpOp(t)}}),document.getElementById("searchEmpForm").addEventListener("submit",submitSearchEmpForm),checkedAttendEvent(),initMultiSelect({selId:selEmp,buttonWidth:300,buttonHeight:300},(n,t)=>{console.log(t);firstSelFilter||(cvEmpPlugin[0].getData().map(n=>n.Type==="emp"?n.IsShow=!1:n),firstSelFilter=!0);const i=cvEmpPlugin[0].getData().find(n=>n.Type==="emp"&&n.Data.EmployeeCode===t);i&&(i.IsShow=n);cvEmpPlugin[0].draw()},n=>{const t=document.querySelectorAll(`#divSelEmp input`)[0];t&&t.value&&t.value!==""?console.log(t.value):(cvEmpPlugin[0].getData().map(t=>t.Type==="emp"?t.IsShow=n:t),cvEmpPlugin[0].draw())}),initMultiSelect({selId:selSkill,buttonWidth:190,buttonHeight:300},(n,t)=>{n?console.log(`selected: ${t}`):console.log(`unselected: ${t}`)},()=>{}),initMultiSelect({selId:SelSection,buttonWidth:190,buttonHeight:300},(n,t)=>{console.log(t),$(`#${SelSection} option:selected`).length>=6?$(`#${SelSection} option`).each((n,t)=>{if($(t).is(":selected"))console.log(t.value);else{const n=$(`input[value="${t.value}"]`);n.prop("disabled",!0);n.parent("li").addClass("disabled")}}):$(`#${SelSection} option`).each((n,t)=>{const i=$(`input[value="${t.value}"]`);i.prop("disabled",!1);i.parent("li").addClass("disabled")})},n=>{console.log(n)},!1),formatDateYYYYMMDD(),attendanceDateOnchanged()})();