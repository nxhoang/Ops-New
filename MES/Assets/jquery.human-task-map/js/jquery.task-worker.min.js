(function(n){function i(n){return new Promise(function(t,i){const r=new Image;r.onload=function(){t(r)};r.onerror=function(n){i(n)};r.src=n})}const r="btnOpEmpRefresh",t="btnOpEmpSaveChanges",u="btnTopAlign";n.fn.humanMapPlugin=function(f){function d(){const e=document.createElement("div"),i=document.createElement("button"),n=document.createElement("button"),f=document.createElement("button");return e.classList.add("op-emp-map__div-agc"),e.appendChild(i),e.appendChild(n),i.setAttribute("id",r),i.setAttribute("type","button"),i.setAttribute("title","Refresh layout"),i.appendChild(g()),n.setAttribute("id",t),n.setAttribute("type","button"),n.disabled=!0,n.setAttribute("title","Save changes"),n.appendChild(nt()),f.setAttribute("id",u),f.setAttribute("type","button"),f.setAttribute("title","Align Top"),f.appendChild(tt()),it(i),rt(n),ut(f),e}function g(){const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=document.createElementNS("http://www.w3.org/2000/svg","path"),i=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("viewbox","0 0 20 20"),n.setAttribute("width","20px"),n.setAttribute("height","20px"),t.setAttribute("d","M 10.210938 2.53125 L 10.210938 0 L 5.613281 4.601562 L 10.210938 9.199219 L 10.210938 6.664062 C 15.59375 6.214844 19.066406 9.792969 19.941406 14.496094 C 20.507812 7.664062 16.121094 3.625 10.210938 2.53125 Z M 10.210938 2.53125 "),t.setAttribute("fill","#ffffff"),i.setAttribute("d","M 9.890625 17.441406 L 9.890625 20 L 14.539062 15.351562 L 9.890625 10.703125 L 9.890625 13.265625 C 5.574219 13.625 1.199219 11.46875 0.0585938 5.347656 C -0.515625 12.269531 3.941406 16.339844 9.890625 17.441406 Z M 9.890625 17.441406 "),i.setAttribute("fill","#ffffff"),n.appendChild(t),n.appendChild(i),n}function nt(){const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=document.createElementNS("http://www.w3.org/2000/svg","path"),i=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("viewbox","0 0 20 20"),n.setAttribute("width","20px"),n.setAttribute("height","20px"),t.setAttribute("d","M 19.867188 3.769531 L 16.230469 0.132812 C 16.144531 0.046875 16.03125 0 15.910156 0 L 1.816406 0 C 0.816406 0 0 0.816406 0 1.816406 L 0 18.183594 C 0 19.183594 0.816406 20 1.816406 20 L 18.183594 20 C 19.183594 20 20 19.183594 20 18.183594 L 20 4.089844 C 20 3.96875 19.953125 3.855469 19.867188 3.769531 Z M 4.546875 0.910156 L 14.546875 0.910156 L 14.546875 6.363281 C 14.546875 6.863281 14.136719 7.273438 13.636719 7.273438 L 5.453125 7.273438 C 4.953125 7.273438 4.546875 6.863281 4.546875 6.363281 Z M 16.363281 19.089844 L 3.636719 19.089844 L 3.636719 10.910156 L 16.363281 10.910156 Z M 19.089844 18.183594 C 19.089844 18.683594 18.683594 19.089844 18.183594 19.089844 L 17.273438 19.089844 L 17.273438 10.453125 C 17.273438 10.203125 17.070312 10 16.816406 10 L 3.183594 10 C 2.929688 10 2.726562 10.203125 2.726562 10.453125 L 2.726562 19.089844 L 1.816406 19.089844 C 1.316406 19.089844 0.910156 18.683594 0.910156 18.183594 L 0.910156 1.816406 C 0.910156 1.316406 1.316406 0.910156 1.816406 0.910156 L 3.636719 0.910156 L 3.636719 6.363281 C 3.636719 7.367188 4.453125 8.183594 5.453125 8.183594 L 13.636719 8.183594 C 14.640625 8.183594 15.453125 7.367188 15.453125 6.363281 L 15.453125 0.910156 L 15.722656 0.910156 L 19.089844 4.277344 Z M 19.089844 18.183594 "),t.setAttribute("fill","#ffffff"),i.setAttribute("d","M 11.363281 6.363281 L 13.183594 6.363281 C 13.433594 6.363281 13.636719 6.160156 13.636719 5.910156 L 13.636719 2.273438 C 13.636719 2.019531 13.433594 1.816406 13.183594 1.816406 L 11.363281 1.816406 C 11.113281 1.816406 10.910156 2.019531 10.910156 2.273438 L 10.910156 5.910156 C 10.910156 6.160156 11.113281 6.363281 11.363281 6.363281 Z M 11.816406 2.726562 L 12.726562 2.726562 L 12.726562 5.453125 L 11.816406 5.453125 Z M 11.816406 2.726562 "),i.setAttribute("fill","#ffffff"),n.appendChild(t),n.appendChild(i),n}function tt(){const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("viewbox","0 0 20 20"),n.setAttribute("width","20px"),n.setAttribute("height","20px"),t.setAttribute("d","M 9.449219 3.054688 L 2.066406 3.054688 L 2.066406 20.109375 L 9.449219 20.109375 Z M 8.6875 19.34375 L 2.832031 19.34375 L 2.832031 3.816406 L 8.6875 3.816406 Z M 18.738281 3.054688 L 11.359375 3.054688 L 11.359375 13.042969 L 18.742188 13.042969 L 18.742188 3.054688 Z M 17.976562 12.28125 L 12.121094 12.28125 L 12.121094 3.816406 L 17.976562 3.816406 Z M 0.222656 1.335938 L 0.222656 0 L 19.886719 0 L 19.886719 1.335938 Z M 0.222656 1.335938 "),t.setAttribute("fill","#ffffff"),n.appendChild(t),n}function it(n){n.addEventListener("click",n=>{if(o.onRefreshCanvas)o.onRefreshCanvas(n,h)})}function rt(n){n.addEventListener("click",n=>{if(o.onSaveCanvas)o.onSaveCanvas(n,o.RectArray)})}function ut(n){n.addEventListener("click",()=>{console.log("align top")})}function ft(){return o.RectArray}function et(n,t,i){e.save();const r=ot(n,t);if(!(r.length<2)){n=r[0];t=r[r.length-1];const u=t.x-n.x,f=t.y-n.y,o=Math.sqrt(u*u+f*f);e.translate(t.x,t.y);e.rotate(Math.atan2(f,u));e.lineCap="round";e.beginPath();e.moveTo(0,0);e.lineTo(-o,0);e.closePath();e.strokeStyle="#3b3b3b";e.stroke();e.beginPath();e.moveTo(0,0);e.lineTo(-i,-i);e.lineTo(-i,i);e.closePath();e.fillStyle="#3b3b3b";e.fill();e.restore()}}function ot(n,t,i){i||(i=220);const r=Math.abs(t.x-n.x),u=Math.abs(t.y-n.y),c=t.x>n.x?1:-1,l=t.y>n.y?1:-1,o=Math.min(n.x,t.x),s=Math.min(n.y,t.y),a=e.getImageData(o,s,r+1,u+1).data,h=[];var f=null;for(let e=n.x,v=n.y,y=r-u;e!==t.x||v!==t.y;){const n=a[((v-s)*(r+1)+e-o)*4+3];f!==null&&(f?n<i:n>=i)&&h.push({x:e,y:v});const t=2*y;t>-u&&(y-=u,e+=c);t<r&&(y+=r,v+=l);f=n>=i}return h}function st(n){const t=n.X,i=n.Y;n.Data.ImageUrl===null||n.Data.ImageUrl===undefined||n.Data.ImageUrl.trim()===""?n.Data.Gender&&n.Data.Gender==="Male"?e.drawImage(y,t+20,i+2,60,60):e.drawImage(p,t+20,i+2,60,60):n.Data.UserImg&&e.drawImage(n.Data.UserImg,t+20,i+2,60,60);e.font="8px Comic Sans MS";e.fillStyle=n.TextColor;let r="",u="",f="",o="";n&&n.Data&&(n.Data.Name&&(r=n.Data.Name),n.Data.EmployeeCode&&(u=n.Data.EmployeeCode),n.Data.Department&&(f=n.Data.Department),n.Data.Position&&(o=n.Data.Position));e.fillText(r,t+5,i+72);e.fillText(`Id: ${u}`,t+5,i+81);e.fillText(`Dept: ${f}`,t+5,i+90);e.fillText(`Pos: ${o}`,t+5,i+99)}function ht(n,t,i,r,u,f){const o=t.split(" ");let e="";for(let t=0;t<o.length;t++){const s=e+o[t]+" ",h=n.measureText(s),c=h.width;c>u&&t>0?(n.fillText(e,i,r),e=o[t]+" ",r+=f):e=s}n.fillText(e,i,r)}function ct(n){e.font="13px Times New Roman";e.fillStyle=n.TextColor;const t=n.X,i=n.Y;if(ht(e,`[${n.Data.OpNum}] ${k(n.Data.OpName,89,86)}`,t+5,i+12,95,12),n.Data.Emp){n.Data.Emp.ImageUrl===null||n.Data.Emp.ImageUrl===undefined||n.Data.Emp.ImageUrl.trim()===""?n.Data.Emp.Gender&&n.Data.Emp.Gender==="Male"?e.drawImage(y,t+1,i+79,40,40):e.drawImage(p,t+1,i+79,40,40):e.drawImage(n.Data.Emp.UserImg,t+1,i+79,40,40);e.font="8px Comic Sans MS";e.fillStyle=n.TextColor;const r=n.Data.Emp.Name?b(n.Data.Emp.Name,12):"",u=n.Data.Emp.Position?b(n.Data.Emp.Position,12):"",f=n.Data.Emp.EmployeeCode?n.Data.Emp.EmployeeCode:"";e.fillText(r,t+36,i+95);e.fillText(`Id: ${f}`,t+36,i+105);e.fillText(u,t+36,i+115)}}function b(n,t){if(n.length<=t)return n;const i=n.split(" "),u=`${i[0]} ${i[i.length-1]}`,r=u.length>t?i[0]:u;return r.length>t?k(r,t,t-3):r}function k(n,t,i){return n.length>t?`${n.substring(0,i)}...`:n}function c(){lt();const t=[];for(let n of o.RectArray)if(n.IsShow)if(e.strokeStyle=n.BorderColor,e.fillStyle=n.BackgroundColor,e.lineWidth=1,e.fillRect(n.X,n.Y,n.Width,n.Height),e.strokeRect(n.X,n.Y,n.Width,n.Height),n.Type==="emp")st(n);else if(ct(n),n.Data.NextOp){const i=o.RectArray.filter(t=>t.Type==="prc"&&t.Data.OpSerial.toString()===n.Data.NextOp);i.length>0&&t.push({Start:{x:n.X+50,y:n.Y+60},End:{x:i[0].X+50,y:i[0].Y+60},Size:5})}for(var n of t)et(n.Start,n.End,n.Size)}function lt(){e.clearRect(0,0,o.CanvasWidth,o.CanvasHeight)}function at(n,t){return!(t.left>n.right||t.right<n.left||t.top>n.bottom||t.bottom<n.top)}function vt(n){n.preventDefault();n.stopPropagation();const u=this.getBoundingClientRect(),t=parseInt(n.clientX-u.left),i=parseInt(n.clientY-u.top),f=t-a,e=i-v;let r=!1;for(let n of o.RectArray)o.DragOk&&n.IsDragging&&(n.X+=f,n.Y+=e,n.Type==="prc"&&(h=!0)),n.IsShow&&!r&&t>n.X&&t<n.X+n.Width&&i>n.Y&&i<n.Y+n.Height&&(this.style.cursor="grab",r=!0);r||(this.style.cursor="default");c();a=t;v=i}function yt(n){n.preventDefault();n.stopPropagation();let r=!1;s=null;const u=this.getBoundingClientRect(),t=parseInt(n.clientX-u.left),i=parseInt(n.clientY-u.top);o.DragOk=!1;for(let u of o.RectArray)t>u.X&&t<u.X+u.Width&&i>u.Y&&i<u.Y+u.Height?(r=!0,n.ctrlKey?l?u.BorderColor="#00008b":(u.BorderColor="red",l=!0):(u.BorderColor="red",l=!0),o.DragOk=!0,u.IsDragging=!0,u.Type==="emp"&&u.IsShow&&(s=u),u.Data.Emp&&u.Type==="prc"&&t>u.X&&t<u.X+40&&i>u.Y+78&&i<u.Y+78+40&&(u.IsDragging=!1,pt(u.Data.Emp,t-50,i-60),h=!0,u.Data.Emp=null)):n.ctrlKey||(u.BorderColor=u.TextColor);r||(o.RectArray.map(n=>n.BorderColor=n.TextColor),l=!1);c();a=t;v=i}function pt(n,t,i){const r=o.RectArray.find(t=>t.Type==="emp"&&t.Data.EmployeeCode===n.EmployeeCode);if(r)r.X=t,r.Y=i,r.IsShow=!0;else{const r=new w("emp",t,i,100,120,"#5588ee","#FAF7F8","#5588ee",!1,!0,n);o.RectArray.push(r)}}function wt(n){n.preventDefault();n.stopPropagation();o.DragOk=!1;let t=!1;for(let n of o.RectArray)if(n.IsDragging=!1,s&&n.Type==="prc"&&t===!1&&n.IsShow&&(n.Data.Emp===null||n.Data.Emp===undefined)){const i={left:s.X,top:s.Y,right:s.X+s.Width,bottom:s.Y+s.Height},r={left:n.X,top:n.Y,right:n.X+n.Width,bottom:n.Y+n.Height},u=at(i,r);u===!0&&(t=!0,h=!0,s.IsShow=!1,n.Data.Emp=s.Data,c())}}function bt(){e.scale(o.ScaleX,o.ScaleY);c()}function kt(n){n&&(o.RectArray=n,c())}function dt(n){const t=o.RectArray.filter(n=>n.Type==="prc");o.RectArray=t.concat(n)}function gt(){document.getElementById(t).disabled=!h}class w{constructor(n,t,i,r,u,f,e,o,s,h,c){this.Type=n;this.X=t;this.Y=i;this.Width=r;this.Height=u;this.BorderColor=f;this.BackgroundColor=e;this.TextColor=o;this.IsDragging=s;this.IsShow=h;this.Data=c}}const o=n.extend({DragOk:!1,CanvasWidth:1360,CanvasHeight:700,ScaleX:1.2,ScaleY:1.2,RectArray:[],EmpImgDir:"jquery.human-task-map/img",EmpMaleImg:"male-user.png",EmpFemaleImg:"female-user.png"},f);let e,s=null,a,v,y,p,h=!1,l=!1;return this.each((t,r)=>{r.onclick=gt;const u=document.createElement("canvas"),f=document.createElement("div");f.classList.add("op-emp-map");r.appendChild(d());f.appendChild(u);r.appendChild(f);e=u.getContext("2d");u.width=o.CanvasWidth;u.height=o.CanvasHeight;u.onmousedown=yt;u.onmouseup=wt;u.onmousemove=vt;u.onZoomIn=bt;r.createRect=(n,t,i,r,u,f,e,o,s,h,c)=>new w(n,t,i,r,u,f,e,o,s,h,c);r.bindData=kt;r.getData=ft;r.draw=c;r.reloadEmp=dt;r.isLayoutChange=()=>h;r.setIsChange=n=>h=n;n.when(i(`${o.EmpImgDir}/${o.EmpMaleImg}`),i(`${o.EmpImgDir}/${o.EmpFemaleImg}`)).done((n,t)=>{y=n,p=t,c()})})}})(jQuery);